SELECT @SQL = STRING_AGG(
    '
    USE ' + QUOTENAME(DatabaseName) + ';

    IF EXISTS (SELECT * FROM sys.symmetric_keys WHERE name = ''FTPPSWDKey'')
        DROP SYMMETRIC KEY FTPPSWDKey;

    IF EXISTS (SELECT * FROM sys.certificates WHERE name = ''CertificateETLFTP'')
        DROP CERTIFICATE CertificateETLFTP;

    IF EXISTS (SELECT * FROM sys.symmetric_keys WHERE name = ''##MS_DatabaseMasterKey##'')
        DROP MASTER KEY;

    DECLARE @ReturnMessage NVARCHAR(MAX);
    EXEC [dbo].[BI_spCreateCertificateKey] @ReturnMessage OUTPUT;
    SELECT @ReturnMessage;

    EXEC [dbo].[BI_spETLConfigurationInsert] 
        @clientid    = ''' + ClientCode + ''',
        @FtpPassword = ''' + CONVERT(VARCHAR(256), PasswordHash) + '''; 

    USE msdb;
    EXEC msdb.dbo.sp_start_job @job_name = ''' + JobName + ''';'
, CHAR(13) + CHAR(10))
FROM dbo.ETLClientInfo
WHERE Status = 'Failed'
  AND IsActive = 1;
