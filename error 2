USE BRPLPRD;

-- Only run if SourceCode column exists
IF COL_LENGTH('dbo.ETL_Configuration', 'SourceCode') IS NOT NULL
BEGIN
    SELECT ec.ConfigurationValue AS ftpusername
    FROM dbo.ETL_Configuration ec
    INNER JOIN admindba.dbo.ETLClientInfo ci
        ON ec.SourceCode = ci.ClientCode
    WHERE ec.ConfigurationName = 'ftpUserName'
      AND ec.SourceCode IS NOT NULL
      AND LTRIM(RTRIM(ec.SourceCode)) <> '';
END


--------------------------
USE BRPLPRD;

SELECT 
    ci.ClientCode,
    ftp.ConfigurationValue AS ftpUserName
FROM admindba.dbo.ETLClientInfo ci
OUTER APPLY
(
    SELECT TOP 1 ConfigurationValue
    FROM dbo.ETL_Configuration c
    WHERE c.ConfigurationName = 'ftpUserName'
      AND EXISTS (
          SELECT 1
          FROM dbo.ETL_Configuration cid
          WHERE cid.ConfigurationName LIKE 'ClientID%'
            AND cid.ConfigurationValue = ci.ClientCode
      )
) ftp
ORDER BY ci.ClientCode;

