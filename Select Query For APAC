DECLARE @DBName NVARCHAR(128);
DECLARE @SQL NVARCHAR(MAX);

-- Create a temp table to collect results from all DBs
IF OBJECT_ID('tempdb..#Results') IS NOT NULL DROP TABLE #Results;

CREATE TABLE #Results (
    DatabaseName SYSNAME,
    BusinessEventTemplateID INT,
    BusinessEventTemplateName NVARCHAR(255),
    [OtherColumns] NVARCHAR(MAX) -- adjust or replace with real columns
);

DECLARE db_cursor CURSOR FOR
SELECT name 
FROM master.sys.databases 
WHERE database_id > 4  -- exclude system databases
  AND state_desc = 'ONLINE'; -- skip offline DBs

OPEN db_cursor;
FETCH NEXT FROM db_cursor INTO @DBName;

WHILE @@FETCH_STATUS = 0
BEGIN
    SET @SQL = N'
    IF EXISTS (SELECT 1 FROM ' + QUOTENAME(@DBName) + N'.sys.tables WHERE name = ''inv_businesseventtemplate'')
    BEGIN
        INSERT INTO #Results (DatabaseName, BusinessEventTemplateID, BusinessEventTemplateName)
        SELECT 
            ''' + @DBName + ''',
            BusinessEventTemplateID,
            BusinessEventTemplateName
        FROM ' + QUOTENAME(@DBName) + N'.dbo.inv_businesseventtemplate
        WHERE BusinessEventTemplateName = ''Fund Valuation'';
    END;
    ';

    EXEC sys.sp_executesql @SQL;

    FETCH NEXT FROM db_cursor INTO @DBName;
END

CLOSE db_cursor;
DEALLOCATE db_cursor;

-- Final unified result
SELECT * FROM #Results;
