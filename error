CREATE TABLE #CombinedResults (
    DatabaseName NVARCHAR(50),
    ConfigurationName NVARCHAR(100),
    ConfigurationValue NVARCHAR(MAX),
    ftpPassword NVARCHAR(MAX)
);

DECLARE db_cursor CURSOR FOR
    SELECT name 
    FROM (VALUES 
            ('MFSLPRD'), 
            ('SUSIPRD'), 
            ('DSAPRD')
         ) AS dbs(name);

DECLARE @DBName NVARCHAR(50);
DECLARE @SQL NVARCHAR(MAX);

OPEN db_cursor;
FETCH NEXT FROM db_cursor INTO @DBName;

WHILE @@FETCH_STATUS = 0
BEGIN
    SET @SQL = N'
    USE ' + QUOTENAME(@DBName) + ';
    INSERT INTO #CombinedResults (DatabaseName, ConfigurationName, ConfigurationValue, ftpPassword)
    SELECT ''' + @DBName + ''' AS DatabaseName,
           ConfigurationName,
           ConfigurationValue,
           CONVERT(NVARCHAR(MAX), DECRYPTBYKEYAUTOCERT(CERT_ID(''CertificateETLFTP''), NULL, ConfigurationEncrypted)) AS ftpPassword
    FROM dbo.ETL_configuration
    WHERE ConfigurationName IN (''ClientID'',''ftpPassword'',''dbLevel'',''ftpUserName'');';

    EXEC sp_executesql @SQL;

    FETCH NEXT FROM db_cursor INTO @DBName;
END

CLOSE db_cursor;
DEALLOCATE db_cursor;

SELECT * FROM #CombinedResults;
DROP TABLE #CombinedResults;
