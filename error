DECLARE @sql NVARCHAR(MAX);
DECLARE @DB sysname;

-- Cursor to loop through all relevant databases
DECLARE curDB CURSOR FORWARD_ONLY STATIC FOR  
SELECT [name]   
FROM sys.databases
WHERE [name] NOT IN ('master','model','msdb','tempdb','DefaultDB','admindba','iws_admin') 
  AND name NOT LIKE '%SP'
  AND name NOT LIKE '%snapshot%'
  AND name NOT LIKE '%stg'
  AND name NOT LIKE '%_old'
  AND state_desc NOT LIKE '%RESTORING%'
ORDER BY [name];

OPEN curDB;
FETCH NEXT FROM curDB INTO @DB;

WHILE @@FETCH_STATUS = 0  
BEGIN 
    -- Only proceed if ETL_Configuration exists
    IF OBJECT_ID('['+@DB+'].dbo.ETL_Configuration') IS NOT NULL  
    BEGIN 
        -- Insert all ClientIDs for this database into ETLTempTable
        -- Decryption will be done separately
        SET @sql = N'
        INSERT INTO admindba.dbo.ETLTempTable (DBName, ClientID, ConfigurationEncrypted)
        SELECT DISTINCT 
            DB_NAME() AS DBName,
            ClientID,
            ConfigurationEncrypted
        FROM [' + @DB + '].dbo.ETL_Configuration
        WHERE ConfigurationName = ''ftpPassword'';';

        EXEC(@sql);
    END

    FETCH NEXT FROM curDB INTO @DB;  
END  

CLOSE curDB;  
DEALLOCATE curDB;
