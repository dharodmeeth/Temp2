SET NOCOUNT ON;

-- Step 6a: Insert new rows from ETLTempTable into ETLClientInfo
;WITH ToInsert AS
(
    SELECT 
        t.DatabaseName,
        t.ClientCode,
        CONVERT(VARBINARY(256), t.ftppass) AS PasswordHash,
        t.ftppass AS pwd
    FROM admindba.dbo.ETLTempTable t
    WHERE t.ftppass IS NOT NULL
      AND NOT EXISTS (
          SELECT 1
          FROM admindba.dbo.ETLClientInfo c
          WHERE c.ClientCode = t.ClientCode
            AND c.DatabaseName = t.DatabaseName
      )
)
INSERT INTO admindba.dbo.ETLClientInfo (DatabaseName, ClientCode, PasswordHash, pwd)
OUTPUT inserted.DatabaseName, inserted.ClientCode, inserted.PasswordHash, inserted.pwd
SELECT DatabaseName, ClientCode, PasswordHash, pwd
FROM ToInsert;

-- show how many rows ETLTempTable had with ftppass
SELECT COUNT(*) AS TempRowsWithPassword
FROM admindba.dbo.ETLTempTable
WHERE ftppass IS NOT NULL;

-- show total rows in ETLClientInfo for quick verification
SELECT COUNT(*) AS Total_ETLClientInfo_Rows
FROM admindba.dbo.ETLClientInfo;
