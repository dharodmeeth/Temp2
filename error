-- Step 6b: Merge to update ftpUserName, EtlVersion, ServerName, IsActive
IF @SourceColExists = 1
BEGIN
    -- SourceCode exists
    SET @sql = N'
    MERGE admindba.dbo.ETLClientInfo AS target
    USING (
        SELECT 
            SourceCode AS ClientCode,
            (SELECT TOP 1 ConfigurationValue 
             FROM dbo.ETL_Configuration 
             WHERE ConfigurationName = ''ftpUserName'') AS FtpUserName,
            (SELECT TOP 1 ConfigurationValue 
             FROM dbo.ETL_Configuration 
             WHERE ConfigurationName = ''dbLevel'') AS EtlVersion,
            CAST(SERVERPROPERTY(''MachineName'') AS NVARCHAR(200)) AS ServerName,
            1 AS IsActive
        FROM dbo.ETL_Configuration
        WHERE ISNULL(LTRIM(RTRIM(SourceCode)), '''') <> ''''
    ) AS source
    ON (target.ClientCode = source.ClientCode AND target.DatabaseName = '''+@DB+''')
    WHEN MATCHED THEN
        UPDATE SET 
            target.FtpUserName = source.FtpUserName,
            target.EtlVersion  = source.EtlVersion,
            target.ServerName  = source.ServerName,
            target.IsActive    = source.IsActive
    WHEN NOT MATCHED THEN
        INSERT (ClientCode, FtpUserName, EtlVersion, ServerName, IsActive, DatabaseName)
        VALUES (source.ClientCode, source.FtpUserName, source.EtlVersion, source.ServerName, source.IsActive, '''+@DB+''');';
END
ELSE
BEGIN
    -- SourceCode does not exist â†’ use ClientID from ConfigurationValue
    SET @sql = N'
    MERGE admindba.dbo.ETLClientInfo AS target
    USING (
        SELECT 
            (SELECT TOP 1 ConfigurationValue 
             FROM dbo.ETL_Configuration 
             WHERE ConfigurationName LIKE ''ClientID%'') AS ClientCode,
            (SELECT TOP 1 ConfigurationValue 
             FROM dbo.ETL_Configuration 
             WHERE ConfigurationName = ''ftpUserName'') AS FtpUserName,
            (SELECT TOP 1 ConfigurationValue 
             FROM dbo.ETL_Configuration 
             WHERE ConfigurationName = ''dbLevel'') AS EtlVersion,
            CAST(SERVERPROPERTY(''MachineName'') AS NVARCHAR(200)) AS ServerName,
            1 AS IsActive
    ) AS source
    ON (target.ClientCode = source.ClientCode AND target.DatabaseName = '''+@DB+''')
    WHEN MATCHED THEN
        UPDATE SET 
            target.FtpUserName = source.FtpUserName,
            target.EtlVersion  = source.EtlVersion,
            target.ServerName  = source.ServerName,
            target.IsActive    = source.IsActive
    WHEN NOT MATCHED THEN
        INSERT (ClientCode, FtpUserName, EtlVersion, ServerName, IsActive, DatabaseName)
        VALUES (source.ClientCode, source.FtpUserName, source.EtlVersion, source.ServerName, source.IsActive, '''+@DB+''');';
END;

EXEC (@sql);
