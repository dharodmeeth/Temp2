-- Step 6b: Merge to update ftpUserName, EtlVersion, ServerName, IsActive
IF @SourceColExists = 1
BEGIN
    -- When SourceCode column exists
    SET @sql = N'
    MERGE admindba.dbo.ETLClientInfo AS target
    USING (
        SELECT 
            LTRIM(RTRIM(SourceCode)) AS ClientCode,
            MAX(CASE WHEN ConfigurationName = ''ftpUserName'' THEN ConfigurationValue END) AS FtpUserName,
            MAX(CASE WHEN ConfigurationName = ''ETLVersion'' THEN ConfigurationValue END) AS EtlVersion,
            CAST(SERVERPROPERTY(''MachineName'') AS NVARCHAR(200)) AS ServerName,
            1 AS IsActive
        FROM dbo.ETL_Configuration
        WHERE ISNULL(LTRIM(RTRIM(SourceCode)), '''') <> ''''
        GROUP BY SourceCode
    ) AS source
    ON (target.ClientCode = source.ClientCode AND target.DatabaseName = ''' + @DB + ''')
    WHEN MATCHED THEN
        UPDATE SET 
            target.FtpUserName = source.FtpUserName,
            target.EtlVersion  = source.EtlVersion,
            target.ServerName  = source.ServerName,
            target.IsActive    = source.IsActive
    WHEN NOT MATCHED THEN
        INSERT (DatabaseName, ClientCode, FtpUserName, EtlVersion, ServerName, IsActive)
        VALUES (''' + @DB + ''', source.ClientCode, source.FtpUserName, source.EtlVersion, source.ServerName, source.IsActive);';
END
ELSE
BEGIN
    -- When SourceCode column does NOT exist â†’ use ClientID from ConfigurationValue
    SET @sql = N'
    MERGE admindba.dbo.ETLClientInfo AS target
    USING (
        SELECT 
            (SELECT ConfigurationValue 
             FROM dbo.ETL_Configuration 
             WHERE ConfigurationName LIKE ''ClientID%'') AS ClientCode,
            MAX(CASE WHEN ConfigurationName = ''ftpUserName'' THEN ConfigurationValue END) AS FtpUserName,
            MAX(CASE WHEN ConfigurationName = ''ETLVersion'' THEN ConfigurationValue END) AS EtlVersion,
            CAST(SERVERPROPERTY(''MachineName'') AS NVARCHAR(200)) AS ServerName,
            1 AS IsActive
        FROM dbo.ETL_Configuration
    ) AS source
    ON (target.ClientCode = source.ClientCode AND target.DatabaseName = ''' + @DB + ''')
    WHEN MATCHED THEN
        UPDATE SET 
            target.FtpUserName = source.FtpUserName,
            target.EtlVersion  = source.EtlVersion,
            target.ServerName  = source.ServerName,
            target.IsActive    = source.IsActive
    WHEN NOT MATCHED THEN
        INSERT (DatabaseName, ClientCode, FtpUserName, EtlVersion, ServerName, IsActive)
        VALUES (''' + @DB + ''', source.ClientCode, source.FtpUserName, source.EtlVersion, source.ServerName, source.IsActive);';
END;

EXEC (@sql);
