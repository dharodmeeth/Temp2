-- Temp table to collect results
IF OBJECT_ID('tempdb..#ETLResults') IS NOT NULL
    DROP TABLE #ETLResults;

CREATE TABLE #ETLResults
(
    DatabaseName SYSNAME,
    ConfigurationName NVARCHAR(200),
    ConfigurationValue NVARCHAR(MAX),
    ftpPassword NVARCHAR(MAX)
);

DECLARE @db NVARCHAR(128);
DECLARE @sql NVARCHAR(MAX);

-- Cursor through all user databases (skip system DBs)
DECLARE db_cursor CURSOR FOR
SELECT name
FROM sys.databases
WHERE database_id > 4;

OPEN db_cursor;
FETCH NEXT FROM db_cursor INTO @db;

WHILE @@FETCH_STATUS = 0
BEGIN
    SET @sql = '
    IF EXISTS (
        SELECT 1
        FROM ' + QUOTENAME(@db) + '.sys.tables
        WHERE name = ''ETL_configuration''
    )
    BEGIN
        INSERT INTO #ETLResults (DatabaseName, ConfigurationName, ConfigurationValue, ftpPassword)
        SELECT
            ''' + @db + ''' AS DatabaseName,
            ConfigurationName,
            ConfigurationValue,
            CONVERT(NVARCHAR(MAX),
                DECRYPTBYKEYAUTOCERT(CERT_ID(''CertificateETLFTP''), NULL, ConfigurationEncrypted)
            ) AS ftpPassword
        FROM ' + QUOTENAME(@db) + '.dbo.ETL_configuration
        WHERE ConfigurationName IN (''ClientID'', ''ftpPassword'', ''dbLevel'', ''ftpUserName'');
    END
    ELSE
    BEGIN
        -- Optional: insert a row showing table missing
        INSERT INTO #ETLResults (DatabaseName, ConfigurationName, ConfigurationValue, ftpPassword)
        VALUES (''' + @db + ''', NULL, NULL, NULL);
    END';

    EXEC sp_executesql @sql;

    FETCH NEXT FROM db_cursor INTO @db;
END

CLOSE db_cursor;
DEALLOCATE db_cursor;

-- Final output
SELECT *
FROM #ETLResults
ORDER BY DatabaseName, ConfigurationName;
